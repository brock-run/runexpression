#!/usr/bin/env node

/**
 * Generate AI Agent Guide from Source Documentation
 *
 * This script reads all documentation files (DOCS/*.md, docs/adr/*.md) and
 * generates a comprehensive guide for AI agents working on RunExpression.
 *
 * Usage:
 *   node scripts/generate-ai-agent-guide.js
 *
 * Output:
 *   AI-AGENT-GUIDE.md (root directory)
 *
 * This maintains a single source of truth - update source docs, then regenerate.
 */

const fs = require('fs');
const path = require('path');

// Configuration
const SOURCE_DIRS = [
  { path: 'DOCS', pattern: /\.md$/, category: 'Core Documentation' },
  { path: 'docs/adr', pattern: /\.md$/, category: 'Architectural Decision Records' }
];

const OUTPUT_FILE = 'AI-AGENT-GUIDE.md';
const ROOT_DIR = path.join(__dirname, '..');

/**
 * Read all markdown files from a directory
 */
function readMarkdownFiles(dirPath, pattern) {
  const fullPath = path.join(ROOT_DIR, dirPath);

  if (!fs.existsSync(fullPath)) {
    console.warn(`Warning: Directory ${dirPath} does not exist`);
    return [];
  }

  const files = fs.readdirSync(fullPath)
    .filter(file => pattern.test(file))
    .sort();

  return files.map(file => {
    const filePath = path.join(fullPath, file);
    const content = fs.readFileSync(filePath, 'utf-8');
    return {
      filename: file,
      path: path.join(dirPath, file),
      content
    };
  });
}

/**
 * Extract key sections from documentation
 */
function extractKeySections(doc) {
  const sections = {
    overview: '',
    technicalDetails: '',
    patterns: '',
    conventions: ''
  };

  // Extract overview (first section or heading)
  const overviewMatch = doc.content.match(/## Overview\n([\s\S]*?)(?=\n## |$)/);
  if (overviewMatch) {
    sections.overview = overviewMatch[1].trim();
  }

  // Extract technical details
  const techMatch = doc.content.match(/## (?:Technical|Architecture|Implementation)([\s\S]*?)(?=\n## |$)/i);
  if (techMatch) {
    sections.technicalDetails = techMatch[0].trim();
  }

  // Extract patterns
  const patternMatch = doc.content.match(/## (?:Patterns|Guidelines|Best Practices)([\s\S]*?)(?=\n## |$)/i);
  if (patternMatch) {
    sections.patterns = patternMatch[0].trim();
  }

  return sections;
}

/**
 * Generate AI Agent Guide
 */
function generateGuide() {
  console.log('ü§ñ Generating AI Agent Guide...\n');

  let guide = `# RunExpression: AI Agent Development Guide

**Last Generated:** ${new Date().toISOString().split('T')[0]}
**Auto-generated from:** DOCS/*.md, docs/adr/*.md

> ‚ö†Ô∏è **DO NOT EDIT THIS FILE DIRECTLY**
>
> This file is auto-generated from source documentation. To update this guide:
> 1. Edit the source documentation in DOCS/ or docs/adr/
> 2. Run: \`node scripts/generate-ai-agent-guide.js\`
> 3. Commit both source docs and regenerated guide

---

## Purpose

This guide provides AI agents (like Claude, GitHub Copilot, etc.) with comprehensive context about RunExpression's architecture, conventions, and patterns. Use this as a reference when:

- Writing new features
- Fixing bugs
- Reviewing code
- Making architectural decisions
- Answering questions about the codebase

---

## Quick Reference

### Tech Stack
- **Frontend:** Next.js 14+ (App Router), React, TypeScript, Tailwind CSS, Shadcn/UI
- **Backend:** Supabase (PostgreSQL + Auth + Storage + Realtime)
- **Payments:** Stripe (Hosted Checkout)
- **Content:** MDX (next-mdx-remote)
- **Animations:** Framer Motion
- **Deployment:** Vercel

### Project Structure
\`\`\`
/app/              # Next.js App Router pages
  (public)/        # Public routes (no auth)
  (flow)/          # Flow feature routes
  (app)/           # Authenticated routes
  api/             # API routes
/components/       # React components
  ui/              # Shadcn/UI components
  flow/            # Flow-specific components
  clubhouse/       # Clubhouse-specific components
/lib/              # Utilities and helpers
  supabase/        # Supabase clients
  types/           # TypeScript types
/DOCS/             # Core documentation
/docs/adr/         # Architectural Decision Records
\`\`\`

### Key Commands
\`\`\`bash
npm run dev        # Start development server
npm run build      # Build for production
npm run lint       # Run ESLint
npm run test       # Run tests
npm run type-check # TypeScript type checking
\`\`\`

---

`;

  // Process each source directory
  SOURCE_DIRS.forEach(({ path: dirPath, pattern, category }) => {
    console.log(`üìÇ Processing ${category} (${dirPath})...`);

    guide += `## ${category}\n\n`;
    guide += `> Source: \`${dirPath}/\`\n\n`;

    const docs = readMarkdownFiles(dirPath, pattern);

    if (docs.length === 0) {
      guide += `*No documents found in ${dirPath}*\n\n`;
      console.log(`   ‚ö†Ô∏è  No documents found\n`);
      return;
    }

    docs.forEach(doc => {
      console.log(`   ‚úì ${doc.filename}`);

      guide += `### ${doc.filename.replace('.md', '')}\n\n`;
      guide += `**File:** \`${doc.path}\`\n\n`;

      // For ADRs, include full content (they're concise)
      if (dirPath === 'docs/adr' && !doc.filename.includes('README') && !doc.filename.includes('template')) {
        // Extract just the key sections from ADRs
        const contextMatch = doc.content.match(/## Context\n([\s\S]*?)(?=\n## |$)/);
        const decisionMatch = doc.content.match(/## Decision\n([\s\S]*?)(?=\n## |$)/);
        const consequencesMatch = doc.content.match(/## Consequences\n([\s\S]*?)(?=\n## |$)/);

        if (contextMatch) {
          guide += `**Context:**\n${contextMatch[1].trim()}\n\n`;
        }
        if (decisionMatch) {
          guide += `**Decision:**\n${decisionMatch[1].trim()}\n\n`;
        }
        if (consequencesMatch) {
          guide += `**Key Consequences:**\n${consequencesMatch[1].trim().split('\n').slice(0, 10).join('\n')}\n\n`;
        }

        guide += `*[Full details in ${doc.path}]*\n\n`;
      } else if (dirPath === 'DOCS') {
        // For DOCS, include overview and key sections
        const overviewMatch = doc.content.match(/## Overview\n([\s\S]*?)(?=\n## |$)/);
        if (overviewMatch) {
          guide += `**Overview:**\n${overviewMatch[1].trim()}\n\n`;
        }

        guide += `*[Full details in ${doc.path}]*\n\n`;
      }

      guide += `---\n\n`;
    });

    console.log();
  });

  // Add practical guidelines section
  guide += `## Practical Guidelines for AI Agents

### When Writing Code

1. **Follow TypeScript standards** (DOCS/07-CODING-STANDARDS.md)
   - Always use explicit types
   - Prefer interfaces for objects
   - Use \`unknown\` instead of \`any\`

2. **Follow database conventions** (DOCS/08-DATABASE-CONVENTIONS.md)
   - Table names: plural, snake_case
   - Enable RLS on all tables
   - Use JSONB for flexible attributes

3. **Follow UI/UX patterns** (DOCS/09-UI-UX-PATTERNS.md)
   - Default to Server Components
   - Use Shadcn/UI components
   - Ensure WCAG AA accessibility

4. **Follow git workflow** (DOCS/10-GIT-WORKFLOW.md)
   - Use conventional commit format
   - Keep PRs small (<300 lines)
   - Write clear commit messages

### When Making Decisions

**Check ADRs first** (docs/adr/):
- Why Next.js App Router? ‚Üí ADR-001
- Why Supabase? ‚Üí ADR-002
- Why monolith? ‚Üí ADR-003
- Why hybrid schema? ‚Üí ADR-004
- Why MDX? ‚Üí ADR-005
- Why Stripe Hosted Checkout? ‚Üí ADR-006
- Why OpenAI Moderation? ‚Üí ADR-007
- Why client-side compression? ‚Üí ADR-008
- Why Shadcn/UI? ‚Üí ADR-009
- Why defer sticker studio? ‚Üí ADR-010

### When Implementing Features

**Refer to:**
- **Product requirements:** DOCS/02-PRODUCT-REQUIREMENTS.md
- **Technical design:** DOCS/03-TECHNICAL-DESIGN.md
- **Database schema:** DOCS/06-DATA-SCHEMA.md
- **Implementation plan:** DOCS/05-IMPLEMENTATION-PLAN.md

### When Reviewing Code

**Check:**
- TypeScript types are explicit
- RLS policies protect data
- Components are accessible (ARIA, keyboard nav)
- Commit messages follow conventional format
- Tests are included for new logic

### When Stuck

**Resources:**
1. Check relevant ADR for architectural context
2. Check DOCS/ for implementation details
3. Check coding standards for conventions
4. Ask for clarification if ambiguous

---

## Brand Voice & Philosophy

**From DOCS/04-BRAND-CONTENT-GUIDE.md:**

RunExpression is "The Sage in the Parking Lot" ‚Äî deep but accessible, serious but lighthearted.

**Four Pillars:**
1. **Motion Creates Emotion** - Physical movement unlocks emotional processing
2. **Process Over Outcome** - The journey matters more than the destination
3. **Interdependence** - We need each other (shift from independence)
4. **Living Laboratory** - Experiment, learn, adapt

**Tone:** Vulnerable, honest, generative, invitational (not prescriptive)

---

## Common Patterns

### API Route Pattern
\`\`\`typescript
// app/api/flow/submit/route.ts
export async function POST(request: Request) {
  try {
    // 1. Auth check
    const supabase = createClient()
    const { data: { user } } = await supabase.auth.getUser()

    // 2. Validate input
    const body = await request.json()
    const result = schema.safeParse(body)
    if (!result.success) {
      return NextResponse.json({ error: result.error }, { status: 400 })
    }

    // 3. Process request
    const { data, error } = await supabase
      .from('table')
      .insert({ ...result.data, user_id: user?.id })

    if (error) {
      return NextResponse.json({ error: error.message }, { status: 500 })
    }

    return NextResponse.json({ data })
  } catch (error) {
    console.error('Error:', error)
    return NextResponse.json({ error: 'Internal server error' }, { status: 500 })
  }
}
\`\`\`

### Component Pattern
\`\`\`typescript
// components/flow/flow-post-card.tsx
import type { FlowPost } from '@/lib/types/flow'

interface FlowPostCardProps {
  post: FlowPost
}

export function FlowPostCard({ post }: FlowPostCardProps) {
  return (
    <div className="rounded-lg border p-6">
      {/* Component content */}
    </div>
  )
}
\`\`\`

### Database Query Pattern
\`\`\`typescript
// Fetch with RLS protection
const { data, error } = await supabase
  .from('expression_events')
  .select('id, content, created_at, profiles:user_id(full_name)')
  .eq('moderation_status', 'approved')
  .order('created_at', { ascending: false })
  .limit(20)
\`\`\`

---

## Version History

| Date       | Changes                                      |
|------------|----------------------------------------------|
| 2025-12-14 | Initial AI Agent Guide generated             |

---

**Questions or unclear requirements?** Check the source documentation or ask for clarification.
`;

  // Write guide to file
  const outputPath = path.join(ROOT_DIR, OUTPUT_FILE);
  fs.writeFileSync(outputPath, guide);

  console.log(`‚úÖ AI Agent Guide generated: ${OUTPUT_FILE}`);
  console.log(`üìä Total size: ${Math.round(guide.length / 1024)}KB`);
  console.log(`\nüí° To update: node scripts/generate-ai-agent-guide.js\n`);
}

// Run generator
try {
  generateGuide();
} catch (error) {
  console.error('‚ùå Error generating guide:', error);
  process.exit(1);
}
